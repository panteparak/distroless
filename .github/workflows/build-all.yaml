# Full Build Orchestrator
# Builds ALL distroless images in the correct dependency order.
# Use this for:
# - Initial setup of a new registry
# - Weekly rebuilds to pick up security patches
# - Manual full rebuilds
#
# Dependency order:
#   static → base → cc → python, nodejs
#   static → base-nossl → java

name: Build All Images

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all images (ignore cache)'
        type: boolean
        default: false
      skip_base:
        description: 'Skip base images (static, base, cc) - use existing'
        type: boolean
        default: false
  schedule:
    - cron: '0 0 * * 0'  # Weekly Sunday midnight UTC

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/distroless

jobs:
  # ===========================================================================
  # Tier 1: Foundation (no dependencies)
  # ===========================================================================
  static-root:
    if: inputs.skip_base != true
    uses: ./.github/workflows/_build-image.yaml
    with:
      image: static
      dockerfile: images/static/Dockerfile
      context: images/static
      variant: root
    secrets: inherit

  static-nonroot:
    if: inputs.skip_base != true
    uses: ./.github/workflows/_build-image.yaml
    with:
      image: static
      dockerfile: images/static/Dockerfile
      context: images/static
      variant: nonroot
    secrets: inherit

  # ===========================================================================
  # Tier 2: Base variants (depends on static)
  # ===========================================================================
  base-root:
    needs: static-root
    if: inputs.skip_base != true
    uses: ./.github/workflows/_build-image.yaml
    with:
      image: base
      dockerfile: images/base/Dockerfile
      context: images/base
      variant: root
    secrets: inherit

  base-nonroot:
    needs: static-nonroot
    if: inputs.skip_base != true
    uses: ./.github/workflows/_build-image.yaml
    with:
      image: base
      dockerfile: images/base/Dockerfile
      context: images/base
      variant: nonroot
    secrets: inherit

  base-nossl-root:
    needs: static-root
    if: inputs.skip_base != true
    uses: ./.github/workflows/_build-image.yaml
    with:
      image: base-nossl
      dockerfile: images/base-nossl/Dockerfile
      context: images/base-nossl
      variant: root
    secrets: inherit

  base-nossl-nonroot:
    needs: static-nonroot
    if: inputs.skip_base != true
    uses: ./.github/workflows/_build-image.yaml
    with:
      image: base-nossl
      dockerfile: images/base-nossl/Dockerfile
      context: images/base-nossl
      variant: nonroot
    secrets: inherit

  # ===========================================================================
  # Tier 3: Runtime layers (depends on base)
  # ===========================================================================
  cc-root:
    needs: base-root
    if: inputs.skip_base != true
    uses: ./.github/workflows/_build-image.yaml
    with:
      image: cc
      dockerfile: images/cc/Dockerfile
      context: images/cc
      variant: root
    secrets: inherit

  cc-nonroot:
    needs: base-nonroot
    if: inputs.skip_base != true
    uses: ./.github/workflows/_build-image.yaml
    with:
      image: cc
      dockerfile: images/cc/Dockerfile
      context: images/cc
      variant: nonroot
    secrets: inherit

  # ===========================================================================
  # Tier 4: Language runtimes (parallel within tier)
  # ===========================================================================

  # Python builds (depends on cc)
  python:
    needs: [cc-root, cc-nonroot]
    if: always() && (needs.cc-root.result == 'success' || inputs.skip_base == true)
    strategy:
      fail-fast: false
      matrix:
        version: ['3.10', '3.11', '3.12', '3.13']
        variant: [root, nonroot]
    uses: ./.github/workflows/_build-image.yaml
    with:
      image: python
      version: ${{ matrix.version }}
      dockerfile: images/python/Dockerfile.${{ matrix.version }}
      context: images/python
      variant: ${{ matrix.variant }}
    secrets: inherit

  # Node.js builds (depends on cc)
  nodejs:
    needs: [cc-root, cc-nonroot]
    if: always() && (needs.cc-root.result == 'success' || inputs.skip_base == true)
    strategy:
      fail-fast: false
      matrix:
        version: ['20', '22', '24']
        variant: [root, nonroot]
    uses: ./.github/workflows/_build-image.yaml
    with:
      image: nodejs
      version: ${{ matrix.version }}
      dockerfile: images/nodejs/Dockerfile.${{ matrix.version }}
      context: images/nodejs
      variant: ${{ matrix.variant }}
    secrets: inherit

  # Java builds (depends on base-nossl)
  java:
    needs: [base-nossl-root, base-nossl-nonroot]
    if: always() && (needs.base-nossl-root.result == 'success' || inputs.skip_base == true)
    strategy:
      fail-fast: false
      matrix:
        version: ['17', '21']
        variant: [root, nonroot]
    uses: ./.github/workflows/_build-image.yaml
    with:
      image: java
      version: ${{ matrix.version }}
      dockerfile: images/java/Dockerfile.${{ matrix.version }}
      context: images/java
      variant: ${{ matrix.variant }}
    secrets: inherit

  # ===========================================================================
  # Tier 5: Debug variants (after all production images)
  # ===========================================================================

  # Base image debug variants
  debug-base:
    needs: [static-root, static-nonroot, base-root, base-nonroot, cc-root, cc-nonroot]
    if: always() && (needs.static-root.result == 'success' || inputs.skip_base == true)
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: static
            variant: root
          - image: static
            variant: nonroot
          - image: base
            variant: root
          - image: base
            variant: nonroot
          - image: cc
            variant: root
          - image: cc
            variant: nonroot
    uses: ./.github/workflows/_build-debug.yaml
    with:
      image: ${{ matrix.image }}
      variant: ${{ matrix.variant }}
    secrets: inherit

  # Language runtime debug variants
  debug-runtimes:
    needs: [python, nodejs, java]
    if: always()
    strategy:
      fail-fast: false
      matrix:
        include:
          # Python debug (latest version only to save time)
          - image: python
            version: '3.13'
            variant: root
          - image: python
            version: '3.13'
            variant: nonroot
          # Node.js debug (LTS only)
          - image: nodejs
            version: '22'
            variant: root
          - image: nodejs
            version: '22'
            variant: nonroot
          # Java debug (latest LTS)
          - image: java
            version: '21'
            variant: root
          - image: java
            version: '21'
            variant: nonroot
    uses: ./.github/workflows/_build-debug.yaml
    with:
      image: ${{ matrix.image }}
      version: ${{ matrix.version }}
      variant: ${{ matrix.variant }}
    secrets: inherit

  # ===========================================================================
  # Summary
  # ===========================================================================
  summary:
    needs: [debug-base, debug-runtimes]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Build Summary
        env:
          STATIC_ROOT: ${{ needs.static-root.result }}
          BASE_ROOT: ${{ needs.base-root.result }}
          CC_ROOT: ${{ needs.cc-root.result }}
          PYTHON: ${{ needs.python.result }}
          NODEJS: ${{ needs.nodejs.result }}
          JAVA: ${{ needs.java.result }}
          DEBUG_BASE: ${{ needs.debug-base.result }}
          DEBUG_RUNTIMES: ${{ needs.debug-runtimes.result }}
        run: |
          echo "## Build Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Image | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| static | ${STATIC_ROOT:-skipped} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| base | ${BASE_ROOT:-skipped} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| cc | ${CC_ROOT:-skipped} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| python | ${PYTHON:-skipped} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| nodejs | ${NODEJS:-skipped} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| java | ${JAVA:-skipped} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| debug-base | ${DEBUG_BASE:-skipped} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| debug-runtimes | ${DEBUG_RUNTIMES:-skipped} |" >> "$GITHUB_STEP_SUMMARY"

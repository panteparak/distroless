# Unified CI Workflow with Dynamic Matrix
# ========================================
# Uses tiered dynamic matrices to build only what changed
# while respecting dependency order.
#
# Image dependency chain:
#   static → base → cc → python, nodejs, golang:cgo
#   static → base-nossl → java
#   static → golang:static

name: CI

on:
  push:
    branches: [main]
  pull_request:
  schedule:
    - cron: '0 0 * * 0'  # Weekly rebuild
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all images'
        type: boolean
        default: false

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/distroless
  DEBIAN_VERSION: debian12

jobs:
  # ============================================================================
  # CHANGE DETECTION & MATRIX GENERATION
  # ============================================================================
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      # Change flags
      any_changes: ${{ steps.changes.outputs.any_changes }}
      # Tier matrices
      tier1_matrix: ${{ steps.matrix.outputs.tier1 }}
      tier2_matrix: ${{ steps.matrix.outputs.tier2 }}
      tier3_matrix: ${{ steps.matrix.outputs.tier3 }}
      tier4_matrix: ${{ steps.matrix.outputs.tier4 }}
      debug_matrix: ${{ steps.matrix.outputs.debug }}
      test_matrix: ${{ steps.matrix.outputs.test }}
      scan_matrix: ${{ steps.matrix.outputs.scan }}
      # Skip flags for tiers
      skip_tier1: ${{ steps.matrix.outputs.skip_tier1 }}
      skip_tier2: ${{ steps.matrix.outputs.skip_tier2 }}
      skip_tier3: ${{ steps.matrix.outputs.skip_tier3 }}
      skip_tier4: ${{ steps.matrix.outputs.skip_tier4 }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            static:
              - 'images/static/**'
            base:
              - 'images/base/Dockerfile'
            base_nossl:
              - 'images/base/Dockerfile.nossl'
            cc:
              - 'images/cc/**'
            python:
              - 'images/python/**'
            nodejs:
              - 'images/nodejs/**'
            java:
              - 'images/java/**'
            golang:
              - 'images/golang/**'
            workflows:
              - '.github/workflows/**'

      - name: Calculate changes with cascade
        id: changes
        env:
          FORCE: ${{ github.event_name == 'schedule' || inputs.force_rebuild == true }}
          STATIC: ${{ steps.filter.outputs.static }}
          BASE: ${{ steps.filter.outputs.base }}
          BASE_NOSSL: ${{ steps.filter.outputs.base_nossl }}
          CC: ${{ steps.filter.outputs.cc }}
          PYTHON: ${{ steps.filter.outputs.python }}
          NODEJS: ${{ steps.filter.outputs.nodejs }}
          JAVA: ${{ steps.filter.outputs.java }}
          GOLANG: ${{ steps.filter.outputs.golang }}
          WORKFLOWS: ${{ steps.filter.outputs.workflows }}
        run: |
          # Force or workflow changes = rebuild all
          if [ "$FORCE" == "true" ] || [ "$WORKFLOWS" == "true" ]; then
            echo "static=true" >> "$GITHUB_OUTPUT"
            echo "base=true" >> "$GITHUB_OUTPUT"
            echo "base_nossl=true" >> "$GITHUB_OUTPUT"
            echo "cc=true" >> "$GITHUB_OUTPUT"
            echo "python=true" >> "$GITHUB_OUTPUT"
            echo "nodejs=true" >> "$GITHUB_OUTPUT"
            echo "java=true" >> "$GITHUB_OUTPUT"
            echo "golang=true" >> "$GITHUB_OUTPUT"
            echo "any_changes=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Apply cascade logic
          S=$STATIC; B=$BASE; BN=$BASE_NOSSL; C=$CC
          P=$PYTHON; N=$NODEJS; J=$JAVA; G=$GOLANG

          # static -> base, base-nossl, golang:static
          if [ "$S" == "true" ]; then
            B=true; BN=true; G=true
          fi
          # base -> cc
          if [ "$B" == "true" ]; then
            C=true
          fi
          # cc -> python, nodejs, golang:cgo
          if [ "$C" == "true" ]; then
            P=true; N=true; G=true
          fi
          # base-nossl -> java
          if [ "$BN" == "true" ]; then
            J=true
          fi

          echo "static=$S" >> "$GITHUB_OUTPUT"
          echo "base=$B" >> "$GITHUB_OUTPUT"
          echo "base_nossl=$BN" >> "$GITHUB_OUTPUT"
          echo "cc=$C" >> "$GITHUB_OUTPUT"
          echo "python=$P" >> "$GITHUB_OUTPUT"
          echo "nodejs=$N" >> "$GITHUB_OUTPUT"
          echo "java=$J" >> "$GITHUB_OUTPUT"
          echo "golang=$G" >> "$GITHUB_OUTPUT"

          if [ "$S" == "true" ] || [ "$B" == "true" ] || [ "$BN" == "true" ] || \
             [ "$C" == "true" ] || [ "$P" == "true" ] || [ "$N" == "true" ] || \
             [ "$J" == "true" ] || [ "$G" == "true" ]; then
            echo "any_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "any_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate dynamic matrices
        id: matrix
        env:
          STATIC: ${{ steps.changes.outputs.static }}
          BASE: ${{ steps.changes.outputs.base }}
          BASE_NOSSL: ${{ steps.changes.outputs.base_nossl }}
          CC: ${{ steps.changes.outputs.cc }}
          PYTHON: ${{ steps.changes.outputs.python }}
          NODEJS: ${{ steps.changes.outputs.nodejs }}
          JAVA: ${{ steps.changes.outputs.java }}
          GOLANG: ${{ steps.changes.outputs.golang }}
        run: |
          # Tier 1: static
          TIER1='{"include":[]}'
          if [ "$STATIC" == "true" ]; then
            TIER1=$(jq -n '{include: [
              {image: "static", dockerfile: "images/static/Dockerfile", context: "images/static", variant: "root"},
              {image: "static", dockerfile: "images/static/Dockerfile", context: "images/static", variant: "nonroot"}
            ]}')
          fi
          echo "tier1=$(echo $TIER1 | jq -c)" >> "$GITHUB_OUTPUT"
          echo "skip_tier1=$([ "$STATIC" != "true" ] && echo true || echo false)" >> "$GITHUB_OUTPUT"

          # Tier 2: base, base-nossl
          TIER2='{"include":[]}'
          T2_ITEMS=()
          if [ "$BASE" == "true" ]; then
            T2_ITEMS+=('{"image":"base","dockerfile":"images/base/Dockerfile","context":"images/base","variant":"root"}')
            T2_ITEMS+=('{"image":"base","dockerfile":"images/base/Dockerfile","context":"images/base","variant":"nonroot"}')
          fi
          if [ "$BASE_NOSSL" == "true" ]; then
            T2_ITEMS+=('{"image":"base-nossl","dockerfile":"images/base/Dockerfile.nossl","context":"images/base","variant":"root"}')
            T2_ITEMS+=('{"image":"base-nossl","dockerfile":"images/base/Dockerfile.nossl","context":"images/base","variant":"nonroot"}')
          fi
          if [ ${#T2_ITEMS[@]} -gt 0 ]; then
            TIER2=$(printf '%s\n' "${T2_ITEMS[@]}" | jq -s '{include: .}')
          fi
          echo "tier2=$(echo $TIER2 | jq -c)" >> "$GITHUB_OUTPUT"
          echo "skip_tier2=$([ "$BASE" != "true" ] && [ "$BASE_NOSSL" != "true" ] && echo true || echo false)" >> "$GITHUB_OUTPUT"

          # Tier 3: cc
          TIER3='{"include":[]}'
          if [ "$CC" == "true" ]; then
            TIER3=$(jq -n '{include: [
              {image: "cc", dockerfile: "images/cc/Dockerfile", context: "images/cc", variant: "root"},
              {image: "cc", dockerfile: "images/cc/Dockerfile", context: "images/cc", variant: "nonroot"}
            ]}')
          fi
          echo "tier3=$(echo $TIER3 | jq -c)" >> "$GITHUB_OUTPUT"
          echo "skip_tier3=$([ "$CC" != "true" ] && echo true || echo false)" >> "$GITHUB_OUTPUT"

          # Tier 4: python, nodejs, java, golang (all language runtimes)
          T4_ITEMS=()

          # Python versions
          if [ "$PYTHON" == "true" ]; then
            for ver in 3.9 3.10 3.11 3.12 3.13; do
              for var in root nonroot; do
                T4_ITEMS+=("{\"image\":\"python\",\"version\":\"$ver\",\"dockerfile\":\"images/python/Dockerfile.$ver\",\"context\":\"images/python\",\"variant\":\"$var\"}")
              done
            done
          fi

          # Node.js versions
          if [ "$NODEJS" == "true" ]; then
            for ver in 20 22 24; do
              for var in root nonroot; do
                T4_ITEMS+=("{\"image\":\"nodejs\",\"version\":\"$ver\",\"dockerfile\":\"images/nodejs/Dockerfile.$ver\",\"context\":\"images/nodejs\",\"variant\":\"$var\"}")
              done
            done
          fi

          # Java versions
          if [ "$JAVA" == "true" ]; then
            for ver in 17 21; do
              for var in root nonroot; do
                T4_ITEMS+=("{\"image\":\"java\",\"version\":\"$ver\",\"dockerfile\":\"images/java/Dockerfile.$ver\",\"context\":\"images/java\",\"variant\":\"$var\"}")
              done
            done
          fi

          # Golang variants
          if [ "$GOLANG" == "true" ]; then
            for ver in static cgo; do
              for var in root nonroot; do
                T4_ITEMS+=("{\"image\":\"golang\",\"version\":\"$ver\",\"dockerfile\":\"images/golang/Dockerfile.$ver\",\"context\":\"images/golang\",\"variant\":\"$var\"}")
              done
            done
          fi

          TIER4='{"include":[]}'
          if [ ${#T4_ITEMS[@]} -gt 0 ]; then
            TIER4=$(printf '%s\n' "${T4_ITEMS[@]}" | jq -s '{include: .}')
          fi
          echo "tier4=$(echo $TIER4 | jq -c)" >> "$GITHUB_OUTPUT"
          echo "skip_tier4=$([ ${#T4_ITEMS[@]} -eq 0 ] && echo true || echo false)" >> "$GITHUB_OUTPUT"

          # Debug matrix (latest versions only)
          DEBUG_ITEMS=()
          if [ "$STATIC" == "true" ]; then
            DEBUG_ITEMS+=('{"image":"static","variant":"root"}')
            DEBUG_ITEMS+=('{"image":"static","variant":"nonroot"}')
          fi
          if [ "$BASE" == "true" ]; then
            DEBUG_ITEMS+=('{"image":"base","variant":"root"}')
            DEBUG_ITEMS+=('{"image":"base","variant":"nonroot"}')
          fi
          if [ "$CC" == "true" ]; then
            DEBUG_ITEMS+=('{"image":"cc","variant":"root"}')
            DEBUG_ITEMS+=('{"image":"cc","variant":"nonroot"}')
          fi
          if [ "$PYTHON" == "true" ]; then
            DEBUG_ITEMS+=('{"image":"python","version":"3.13","variant":"root"}')
            DEBUG_ITEMS+=('{"image":"python","version":"3.13","variant":"nonroot"}')
          fi
          if [ "$NODEJS" == "true" ]; then
            DEBUG_ITEMS+=('{"image":"nodejs","version":"24","variant":"root"}')
            DEBUG_ITEMS+=('{"image":"nodejs","version":"24","variant":"nonroot"}')
          fi
          if [ "$JAVA" == "true" ]; then
            DEBUG_ITEMS+=('{"image":"java","version":"21","variant":"root"}')
            DEBUG_ITEMS+=('{"image":"java","version":"21","variant":"nonroot"}')
          fi

          DEBUG='{"include":[]}'
          if [ ${#DEBUG_ITEMS[@]} -gt 0 ]; then
            DEBUG=$(printf '%s\n' "${DEBUG_ITEMS[@]}" | jq -s '{include: .}')
          fi
          echo "debug=$(echo $DEBUG | jq -c)" >> "$GITHUB_OUTPUT"

          # Test matrix (one per image type)
          TEST_ITEMS=()
          [ "$STATIC" == "true" ] && TEST_ITEMS+=('{"image":"static","test_config":"static.yaml"}')
          [ "$BASE" == "true" ] && TEST_ITEMS+=('{"image":"base","test_config":"base.yaml"}')
          [ "$CC" == "true" ] && TEST_ITEMS+=('{"image":"cc","test_config":"cc.yaml"}')
          [ "$PYTHON" == "true" ] && TEST_ITEMS+=('{"image":"python","version":"3.13","test_config":"python.yaml"}')
          [ "$NODEJS" == "true" ] && TEST_ITEMS+=('{"image":"nodejs","version":"24","test_config":"nodejs.yaml"}')
          [ "$JAVA" == "true" ] && TEST_ITEMS+=('{"image":"java","version":"21","test_config":"java.yaml"}')
          [ "$GOLANG" == "true" ] && TEST_ITEMS+=('{"image":"golang","version":"static","test_config":"golang.yaml"}')

          TEST='{"include":[]}'
          if [ ${#TEST_ITEMS[@]} -gt 0 ]; then
            TEST=$(printf '%s\n' "${TEST_ITEMS[@]}" | jq -s '{include: .}')
          fi
          echo "test=$(echo $TEST | jq -c)" >> "$GITHUB_OUTPUT"

          # Scan matrix (same as test for now)
          echo "scan=$(echo $TEST | jq -c)" >> "$GITHUB_OUTPUT"

  # ============================================================================
  # LINT (always runs, parallel jobs)
  # ============================================================================
  lint-dockerfiles:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hadolint/hadolint-action@v3.1.0
        with:
          recursive: true
          ignore: DL3008,DL3013,DL3018,DL3003
          failure-threshold: error

  lint-shell:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ludeeus/action-shellcheck@master
        with:
          severity: warning

  lint-yaml:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ibiqlik/action-yamllint@v3
        with:
          config_data: |
            extends: relaxed
            rules:
              line-length:
                max: 200

  lint-actions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: raven-actions/actionlint@v2
        with:
          fail-on-error: true
          shellcheck: false

  lint-markdown:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DavidAnson/markdownlint-cli2-action@v19
        with:
          globs: '**/*.md'
          config: |
            { "MD013": false, "MD033": false }

  # ============================================================================
  # TIER 1: STATIC (foundation image)
  # ============================================================================
  build-tier1:
    needs: [detect-changes]
    if: needs.detect-changes.outputs.skip_tier1 != 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.detect-changes.outputs.tier1_matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set build args
        id: args
        run: |
          if [ "${{ matrix.variant }}" == "nonroot" ]; then
            echo "uid=65532" >> "$GITHUB_OUTPUT"
            echo "workdir=/home/nonroot" >> "$GITHUB_OUTPUT"
          else
            echo "uid=0" >> "$GITHUB_OUTPUT"
            echo "workdir=/" >> "$GITHUB_OUTPUT"
          fi

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.image }}:${{ env.DEBIAN_VERSION }}-${{ matrix.variant }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.image }}:latest-${{ matrix.variant }}
          build-args: |
            USER=${{ matrix.variant }}
            UID=${{ steps.args.outputs.uid }}
            WORKDIR=${{ steps.args.outputs.workdir }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # TIER 2: BASE & BASE-NOSSL (depends on static)
  # ============================================================================
  build-tier2:
    needs: [detect-changes, build-tier1]
    if: |
      always() && !cancelled() &&
      needs.detect-changes.outputs.skip_tier2 != 'true' &&
      (needs.build-tier1.result == 'success' || needs.build-tier1.result == 'skipped')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.detect-changes.outputs.tier2_matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set build args
        id: args
        run: |
          if [ "${{ matrix.variant }}" == "nonroot" ]; then
            echo "uid=65532" >> "$GITHUB_OUTPUT"
            echo "workdir=/home/nonroot" >> "$GITHUB_OUTPUT"
          else
            echo "uid=0" >> "$GITHUB_OUTPUT"
            echo "workdir=/" >> "$GITHUB_OUTPUT"
          fi

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.image }}:${{ env.DEBIAN_VERSION }}-${{ matrix.variant }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.image }}:latest-${{ matrix.variant }}
          build-args: |
            STATIC_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/static
            TAG=${{ env.DEBIAN_VERSION }}-${{ matrix.variant }}
            USER=${{ matrix.variant }}
            UID=${{ steps.args.outputs.uid }}
            WORKDIR=${{ steps.args.outputs.workdir }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # TIER 3: CC (depends on base)
  # ============================================================================
  build-tier3:
    needs: [detect-changes, build-tier2]
    if: |
      always() && !cancelled() &&
      needs.detect-changes.outputs.skip_tier3 != 'true' &&
      (needs.build-tier2.result == 'success' || needs.build-tier2.result == 'skipped')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.detect-changes.outputs.tier3_matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set build args
        id: args
        run: |
          if [ "${{ matrix.variant }}" == "nonroot" ]; then
            echo "uid=65532" >> "$GITHUB_OUTPUT"
            echo "workdir=/home/nonroot" >> "$GITHUB_OUTPUT"
          else
            echo "uid=0" >> "$GITHUB_OUTPUT"
            echo "workdir=/" >> "$GITHUB_OUTPUT"
          fi

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.image }}:${{ env.DEBIAN_VERSION }}-${{ matrix.variant }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.image }}:latest-${{ matrix.variant }}
          build-args: |
            BASE_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/base
            TAG=${{ env.DEBIAN_VERSION }}-${{ matrix.variant }}
            USER=${{ matrix.variant }}
            UID=${{ steps.args.outputs.uid }}
            WORKDIR=${{ steps.args.outputs.workdir }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # TIER 4: LANGUAGE RUNTIMES (python, nodejs, java, golang)
  # ============================================================================
  build-tier4:
    needs: [detect-changes, build-tier2, build-tier3]
    if: |
      always() && !cancelled() &&
      needs.detect-changes.outputs.skip_tier4 != 'true' &&
      (needs.build-tier2.result == 'success' || needs.build-tier2.result == 'skipped') &&
      (needs.build-tier3.result == 'success' || needs.build-tier3.result == 'skipped')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.detect-changes.outputs.tier4_matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set build args
        id: args
        run: |
          if [ "${{ matrix.variant }}" == "nonroot" ]; then
            echo "uid=65532" >> "$GITHUB_OUTPUT"
            echo "workdir=/home/nonroot" >> "$GITHUB_OUTPUT"
          else
            echo "uid=0" >> "$GITHUB_OUTPUT"
            echo "workdir=/" >> "$GITHUB_OUTPUT"
          fi

          # Determine base image based on image type
          case "${{ matrix.image }}" in
            python|nodejs)
              echo "base_image=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/cc" >> "$GITHUB_OUTPUT"
              echo "base_arg=CC_IMAGE" >> "$GITHUB_OUTPUT"
              ;;
            java)
              echo "base_image=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/base-nossl" >> "$GITHUB_OUTPUT"
              echo "base_arg=BASE_IMAGE" >> "$GITHUB_OUTPUT"
              ;;
            golang)
              if [ "${{ matrix.version }}" == "static" ]; then
                echo "base_image=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/static" >> "$GITHUB_OUTPUT"
                echo "base_arg=STATIC_IMAGE" >> "$GITHUB_OUTPUT"
              else
                echo "base_image=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/cc" >> "$GITHUB_OUTPUT"
                echo "base_arg=CC_IMAGE" >> "$GITHUB_OUTPUT"
              fi
              ;;
          esac

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.image }}:${{ matrix.version }}-${{ env.DEBIAN_VERSION }}-${{ matrix.variant }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.image }}:${{ matrix.version }}-${{ matrix.variant }}
          build-args: |
            ${{ steps.args.outputs.base_arg }}=${{ steps.args.outputs.base_image }}
            TAG=${{ env.DEBIAN_VERSION }}-${{ matrix.variant }}
            USER=${{ matrix.variant }}
            UID=${{ steps.args.outputs.uid }}
            WORKDIR=${{ steps.args.outputs.workdir }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # DEBUG BUILDS
  # ============================================================================
  build-debug:
    needs: [detect-changes, build-tier1, build-tier2, build-tier3, build-tier4]
    if: |
      always() && !cancelled() &&
      needs.detect-changes.outputs.any_changes == 'true' &&
      github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.detect-changes.outputs.debug_matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine base image tag
        id: base
        run: |
          VERSION="${{ matrix.version }}"
          VARIANT="${{ matrix.variant }}"
          IMAGE="${{ matrix.image }}"

          if [ -n "$VERSION" ]; then
            echo "tag=${VERSION}-${{ env.DEBIAN_VERSION }}-${VARIANT}" >> "$GITHUB_OUTPUT"
            echo "debug_tag=${VERSION}-${{ env.DEBIAN_VERSION }}-debug-${VARIANT}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ env.DEBIAN_VERSION }}-${VARIANT}" >> "$GITHUB_OUTPUT"
            echo "debug_tag=${{ env.DEBIAN_VERSION }}-debug-${VARIANT}" >> "$GITHUB_OUTPUT"
          fi

      - name: Build and push debug
        uses: docker/build-push-action@v5
        with:
          context: images/${{ matrix.image }}
          file: images/${{ matrix.image }}/Dockerfile.debug
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.image }}:${{ steps.base.outputs.debug_tag }}
          build-args: |
            BASE_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.image }}
            TAG=${{ steps.base.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # STRUCTURE TESTS
  # ============================================================================
  test:
    needs: [detect-changes, build-tier1, build-tier2, build-tier3, build-tier4]
    if: |
      always() && !cancelled() &&
      needs.detect-changes.outputs.any_changes == 'true' &&
      github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.detect-changes.outputs.test_matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Install container-structure-test
        run: |
          curl -LO https://storage.googleapis.com/container-structure-test/latest/container-structure-test-linux-amd64
          chmod +x container-structure-test-linux-amd64
          sudo mv container-structure-test-linux-amd64 /usr/local/bin/container-structure-test

      - name: Determine image tag
        id: tag
        run: |
          VERSION="${{ matrix.version }}"
          if [ -n "$VERSION" ]; then
            echo "tag=${VERSION}-${{ env.DEBIAN_VERSION }}-root" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ env.DEBIAN_VERSION }}-root" >> "$GITHUB_OUTPUT"
          fi

      - name: Pull image
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.image }}:${{ steps.tag.outputs.tag }}

      - name: Run structure tests
        run: |
          container-structure-test test \
            --image ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.image }}:${{ steps.tag.outputs.tag }} \
            --config tests/structure-tests/${{ matrix.test_config }}

  # ============================================================================
  # SECURITY SCAN
  # ============================================================================
  security-scan:
    needs: [detect-changes, build-tier1, build-tier2, build-tier3, build-tier4]
    if: |
      always() && !cancelled() &&
      needs.detect-changes.outputs.any_changes == 'true' &&
      github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.detect-changes.outputs.scan_matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine image tag
        id: tag
        run: |
          VERSION="${{ matrix.version }}"
          if [ -n "$VERSION" ]; then
            echo "tag=${VERSION}-${{ env.DEBIAN_VERSION }}-root" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ env.DEBIAN_VERSION }}-root" >> "$GITHUB_OUTPUT"
          fi

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.image }}:${{ steps.tag.outputs.tag }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================================================
  # SUMMARY
  # ============================================================================
  summary:
    needs: [lint-dockerfiles, lint-shell, lint-yaml, lint-actions, lint-markdown,
            build-tier1, build-tier2, build-tier3, build-tier4, build-debug, test, security-scan]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dockerfiles | ${{ needs.lint-dockerfiles.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Shell | ${{ needs.lint-shell.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| YAML | ${{ needs.lint-yaml.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Actions | ${{ needs.lint-actions.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Markdown | ${{ needs.lint-markdown.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Build Results" >> $GITHUB_STEP_SUMMARY
          echo "| Tier | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tier 1 (static) | ${{ needs.build-tier1.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tier 2 (base) | ${{ needs.build-tier2.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tier 3 (cc) | ${{ needs.build-tier3.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tier 4 (runtimes) | ${{ needs.build-tier4.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Debug | ${{ needs.build-debug.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Quality Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Check for failures
        if: |
          needs.lint-dockerfiles.result == 'failure' ||
          needs.lint-shell.result == 'failure' ||
          needs.lint-yaml.result == 'failure' ||
          needs.lint-actions.result == 'failure' ||
          needs.build-tier1.result == 'failure' ||
          needs.build-tier2.result == 'failure' ||
          needs.build-tier3.result == 'failure' ||
          needs.build-tier4.result == 'failure'
        run: exit 1

name: Scheduled Rebuild

on:
  schedule:
    - cron: '0 2 * * 1'  # Weekly Monday 2am UTC
  workflow_dispatch:
    inputs:
      force:
        description: 'Force rebuild all images'
        required: false
        default: 'false'
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/distroless

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      should_rebuild: ${{ steps.check.outputs.should_rebuild }}
    steps:
      - uses: actions/checkout@v4

      - name: Check for Debian security updates
        id: check
        env:
          FORCE: ${{ inputs.force }}
        run: |
          # Always rebuild on force or weekly schedule
          if [ "$FORCE" = "true" ]; then
            echo "Force rebuild requested"
            echo "should_rebuild=true" >> "$GITHUB_OUTPUT"
          else
            # Check if Debian has security updates (simplified check)
            echo "Weekly scheduled rebuild"
            echo "should_rebuild=true" >> "$GITHUB_OUTPUT"
          fi

  rebuild-base:
    needs: check-updates
    if: needs.check-updates.outputs.should_rebuild == 'true'
    uses: ./.github/workflows/build-base.yaml
    secrets: inherit
    permissions:
      contents: read
      packages: write
      id-token: write

  rebuild-python:
    needs: [check-updates, rebuild-base]
    if: needs.check-updates.outputs.should_rebuild == 'true'
    uses: ./.github/workflows/build-python.yaml
    secrets: inherit
    permissions:
      contents: read
      packages: write
      id-token: write

  rebuild-nodejs:
    needs: [check-updates, rebuild-base]
    if: needs.check-updates.outputs.should_rebuild == 'true'
    uses: ./.github/workflows/build-nodejs.yaml
    secrets: inherit
    permissions:
      contents: read
      packages: write
      id-token: write

  rebuild-java:
    needs: [check-updates, rebuild-base]
    if: needs.check-updates.outputs.should_rebuild == 'true'
    uses: ./.github/workflows/build-java.yaml
    secrets: inherit
    permissions:
      contents: read
      packages: write
      id-token: write

  security-scan:
    needs: [rebuild-python, rebuild-nodejs, rebuild-java]
    if: always() && needs.check-updates.outputs.should_rebuild == 'true'
    uses: ./.github/workflows/security-scan.yaml
    secrets: inherit
    permissions:
      contents: read
      packages: read
      security-events: write

  notify:
    needs: [rebuild-base, rebuild-python, rebuild-nodejs, rebuild-java, security-scan]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        env:
          BASE_RESULT: ${{ needs.rebuild-base.result }}
          PYTHON_RESULT: ${{ needs.rebuild-python.result }}
          NODEJS_RESULT: ${{ needs.rebuild-nodejs.result }}
          JAVA_RESULT: ${{ needs.rebuild-java.result }}
          SCAN_RESULT: ${{ needs.security-scan.result }}
        run: |
          echo "## Weekly Rebuild Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Image | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Base Images | ${BASE_RESULT} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Python | ${PYTHON_RESULT} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Node.js | ${NODEJS_RESULT} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Java | ${JAVA_RESULT} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Security Scan | ${SCAN_RESULT} |" >> "$GITHUB_STEP_SUMMARY"
